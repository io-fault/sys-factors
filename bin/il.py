"""
Link a set of XML files generated by the inspect role's transformation.
"""
import sys
import itertools
from ...xml import library as libxml

def main():
	cmd, typ, format, *sources = sys.argv[1:]

	index = {None: []}
	k = None
	s = index[k]
	for x in sources:
		if x.startswith('--'):
			k = x.lstrip('--')
			s = index[k] = []
		else:
			s.append(x)
	files = index.pop(None)

	S = libxml.Serialization(xml_encoding='ascii')
	d = libxml.Data.serialize(S.switch('data:'), index)
	src = [
		S.element('source', None, ('xlink:href', 'file://' + x))
		for x in files
	]

	r = S.root('set',
		itertools.chain(
			S.element('parameters', d),
			itertools.chain.from_iterable(src),
		),
		('xmlns:xlink', 'http://www.w3.org/1999/xlink'),
		('xmlns:data', 'https://fault.io/xml/data'),
		namespace='https://fault.io/xml/inspect#set'
	)
	sys.stdout.buffer.writelines(r)

if __name__ == '__main__':
	main()
