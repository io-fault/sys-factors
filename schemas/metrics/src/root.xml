<?xml version="1.0" encoding="utf-8"?>
<!-- XML description of a language agnostic Traceback; a stack of frames !-->
<grammar
	xmlns="http://relaxng.org/ns/structure/1.0"
	ns="http://fault.io/xml/dev/metrics#profile"
	datatypeLibrary="http://www.w3.org/2001/XMLSchema-datatypes"
	xmlns:a="http://relaxng.org/ns/compatibility/annotations/1.0">

	<a:documentation>
		Grammar for representing development metrics.
	</a:documentation>

	<!-- Used to represent tracebacks for test failures. -->

	<define name="libmetrics.xml.id">
		<a:documentation>Name attribute used on most elements.</a:documentation>
		<optional>
			<attribute name="xml:id">
				<a:documentation>
					Fully qualified unique identifier relative to the test context.
				</a:documentation>
				<data type="ID"/>
			</attribute>
		</optional>
	</define>

	<define name="libmetrics.xml.space">
		<attribute name="xml:space">
			<choice>
				<value>default</value>
				<value>preserve</value>
			</choice>
		</attribute>
	</define>

	<define name="libmetrics.identifier">
		<attribute name="identifier">
			<data type="normalizedString"/>
		</attribute>
	</define>

	<define name="libmetrics.report">
		<a:documentation>Set of data describing a factor or a part of a factor.</a:documentation>
		<element name="report">
			<attribute name="timestamp">
				<data type="dateTime"/>
			</attribute>

			<zeroOrMore>
				<ref name="libmetrics.measurements"/>
			</zeroOrMore>
		</element>
	</define>

	<define name="libmetrics.measurements">
		<a:documentation>Data frames container.</a:documentation>
		<element name="measurements">
			<ref name="libmetrics.xml.id"/>

			<optional>
				<attribute name="dimensions">
					<list>
						<zeroOrMore>
							<data type="Name"/>
						</zeroOrMore>
					</list>
				</attribute>
			</optional>

			<optional>
				<attribute name="fields">
					<list>
						<zeroOrMore>
							<data type="Name"/>
						</zeroOrMore>
					</list>
				</attribute>
			</optional>

			<zeroOrMore>
				<ref name="libmetrics.frame"/>
			</zeroOrMore>
		</element>
	</define>

	<define name="libmetrics.key">
		<element>
			<anyName/>
			<optional>
				<ref name="libmetrics.identifier"/>
			</optional>

			<text/>
		</element>
	</define>

	<define name="libmetrics.frame">
		<element name="frame">
			<zeroOrMore>
				<choice>
					<ref name="libmetrics.xml.id"/>
					<attribute>
						<anyName ns="http://fault.io/xml/key"/>
						<text/>
					</attribute>
					<attribute>
						<anyName>
							<except>
								<nsName ns="http://www.w3.org/XML/1998/namespace"/>
								<nsName ns="http://fault.io/xml/key"/>
							</except>
						</anyName>
						<choice>
							<data type="decimal"/>
							<text/>
						</choice>
					</attribute>
				</choice>
			</zeroOrMore>

			<!-- Keys are isolated so measurements can processed independently -->
			<zeroOrMore>
				<ref name="libmetrics.key"/>
			</zeroOrMore>
		</element>
	</define>

	<start>
		<ref name="libmetrics.report"/>
	</start>
</grammar>
